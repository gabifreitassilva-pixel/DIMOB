<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DIMOB Pro | Conversor Universal 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --orange: #ff6600; --bg: #0d0d0d; --card: #161616; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
        .container { max-width: 1000px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card); border: 1px solid #333; padding: 25px; border-radius: 12px; }
        .card h3 { color: var(--orange); border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }
        label { font-size: 11px; color: var(--orange); text-transform: uppercase; font-weight: bold; display: block; margin-top: 10px; }
        input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; margin-top: 5px; }
        .btn { background: var(--orange); color: #fff; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; }
        .btn:hover { filter: brightness(1.1); }
        .obs { font-size: 11px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 40px;">
        <h1>DIMOB <span style="color:#fff">SYSTEM</span></h1>
        <p style="color: var(--orange)">Conversor Inteligente - Layout Oficial RFB</p>
    </header>

    <div class="grid">
        <div class="card">
            <h3><i class="fas fa-file-excel"></i> 1. Planilha</h3>
            <p class="obs">Baixe o modelo. O sistema aceita datas com ou sem barras e valores com ou sem vírgula.</p>
            <button onclick="baixarModelo()" class="btn" style="background: #333;">BAIXAR MODELO BLINDADO</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-user-tie"></i> 2. Declarante</h3>
            <label>CNPJ</label>
            <input type="text" id="cnpj_decl" onblur="consultarEmpresa(this.value)" placeholder="Digite apenas números">
            
            <label>Razão Social</label>
            <input type="text" id="nome_decl">
            
            <label>Endereço Completo (Obrigatório)</label>
            <input type="text" id="end_decl" placeholder="Rua, Número, Bairro...">
            
            <div style="display:grid; grid-template-columns: 3fr 1fr; gap:10px">
                <div>
                    <label>Município</label>
                    <input type="text" id="mun_decl_nome" readonly>
                    <input type="hidden" id="mun_decl_codigo">
                </div>
                <div>
                    <label>UF</label>
                    <input type="text" id="uf_decl" readonly>
                </div>
            </div>

            <label>CPF do Responsável (RFB)</label>
            <input type="text" id="cpf_resp" placeholder="Obrigatório para R01">
        </div>

        <div class="card">
            <h3><i class="fas fa-cogs"></i> 3. Conversão</h3>
            <p class="obs">Anexe a planilha preenchida. O sistema corrigirá a formatação automaticamente.</p>
            <input type="file" id="arquivo_input" accept=".xlsx">
            <button onclick="gerarTxtFinal()" class="btn">CONVERTER E BAIXAR</button>
        </div>
    </div>
</div>

<script src="baseMunicipios.js"></script>

<script>
// ============================================================
// 1. FUNÇÕES DE HIGIENIZAÇÃO DE DADOS (O SEGREDO DO SUCESSO)
// ============================================================

// Normaliza texto: remove acentos, ç, e força maiúsculas. Garante tamanho exato.
const fX = (v, t) => {
    let s = (v || "").toString().toUpperCase();
    s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Remove acentos
    return s.padEnd(t, " ").substring(0, t); // Corta ou preenche
};

// Normaliza números: deixa apenas dígitos e preenche com zeros à esquerda
const fN = (v, t) => {
    let s = (v || "0").toString().replace(/\D/g, ""); 
    return s.padStart(t, "0").substring(0, t);
};

// Lógica Inteligente para Documentos (CPF vs CNPJ)
// O Manual exige: CNPJ (14 pos) preenche tudo. CPF (11 pos) alinha à esquerda + brancos.
const fDoc = (v) => {
    let s = (v || "").toString().replace(/\D/g, ""); // Remove ponto, traço, barra
    if (s.length > 11) {
        // Trata como CNPJ (14 digitos)
        return s.padStart(14, "0").substring(0, 14);
    } else {
        // Trata como CPF (11 digitos)
        return s.padStart(11, "0").padEnd(14, " ");
    }
};

// Lógica Inteligente para Valores (Centavos)
// Aceita: "250000", "250.000,00", "250000.00"
// Retorna: 00000025000000 (formato DIMOB)
const fVal = (v, t) => {
    if (!v) return "0".padStart(t, "0");
    // Troca virgula por ponto se necessário para o JS entender
    let s = v.toString().replace(",", ".");
    let num = parseFloat(s);
    if (isNaN(num)) return "0".padStart(t, "0");
    
    // Multiplica por 100 para eliminar casas decimais e virar inteiro
    let centavos = Math.round(num * 100);
    return centavos.toString().padStart(t, "0").substring(0, t);
};

// Lógica Inteligente para Datas
// Aceita: Excel Serial (45322), "01/01/2025", "1-1-25", "01012025"
// Retorna: DDMMAAAA
const fData = (v) => {
    if (!v) return "00000000";
    
    // Se for número serial do Excel (ex: 45000)
    if (typeof v === 'number' && v > 20000 && v < 60000) {
        let date = new Date(Math.round((v - 25569) * 86400 * 1000));
        let d = date.getUTCDate().toString().padStart(2, '0');
        let m = (date.getUTCMonth() + 1).toString().padStart(2, '0');
        let a = date.getUTCFullYear();
        return `${d}${m}${a}`;
    }

    let s = v.toString().replace(/\D/g, ""); // Remove barras
    
    // Tenta salvar datas digitadas como 112025 (1/1/2025)
    if (s.length === 6) s = "0" + s[0] + "0" + s.slice(1);
    else if (s.length === 7) s = "0" + s;
    
    return s.padStart(8, "0").substring(0, 8);
};

// Normalizador de Cidades para busca
function normalizarCidade(texto) {
    return texto ? texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : "";
}

// ============================================================
// 2. LÓGICA DE NEGÓCIO E GERAÇÃO
// ============================================================

async function consultarEmpresa(cnpj) {
    const limpo = cnpj.replace(/\D/g, "");
    if (limpo.length !== 14) return;
    
    try {
        const res = await fetch(`https://publica.cnpj.ws/cnpj/${limpo}`);
        const data = await res.json();
        
        if (data.razao_social) {
            document.getElementById('nome_decl').value = data.razao_social;
            const e = data.estabelecimento;
            // Monta endereço completo para o R01
            const end = `${e.tipo_logradouro} ${e.logradouro}, ${e.numero} ${e.complemento||""} - ${e.bairro}`.trim();
            document.getElementById('end_decl').value = end;
            
            document.getElementById('mun_decl_nome').value = e.cidade.nome;
            document.getElementById('uf_decl').value = e.estado.sigla;
            
            // Busca código
            const cod = MUNICIPIOS_RFB[normalizarCidade(e.cidade.nome)] || "";
            document.getElementById('mun_decl_codigo').value = cod;
            
            if(!cod) alert("Atenção: Cidade encontrada mas sem código na base interna.");
        }
    } catch (e) { console.log("Erro na consulta automática"); }
}

function gerarTxtFinal() {
    const cnpj = document.getElementById('cnpj_decl').value;
    const nome = document.getElementById('nome_decl').value;
    const end = document.getElementById('end_decl').value;
    const uf = document.getElementById('uf_decl').value;
    const cpfR = document.getElementById('cpf_resp').value;
    const munC = document.getElementById('mun_decl_codigo').value;
    const file = document.getElementById('arquivo_input').files[0];

    // Validações Básicas
    if (!file) return alert("Por favor, selecione o arquivo XLSX.");
    if (!cnpj || !cpfR) return alert("CNPJ e CPF do Responsável são obrigatórios.");
    if (!end) return alert("O Endereço do Declarante é obrigatório para o Registro R01.");

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        // raw: false força o XLSX a tentar interpretar datas e formatos
        const wb = XLSX.read(data, {type: 'array', raw: false}); 
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

        let txt = "DIMOB" + "".padEnd(369, " ") + "\r\n"; // Header

        // R01 - DADOS INICIAIS (Total 272 bytes)
        txt += "R01";
        txt += fN(cnpj, 14);
        txt += "2025";
        txt += "0"; // Retificadora (Não)
        txt += "".padEnd(10, "0"); // Num Recibo
        txt += "0"; // Situação Especial
        txt += "00000000"; // Data Situação
        txt += "00"; // Cod Situação
        txt += fX(nome, 60);
        txt += fN(cpfR, 11);
        txt += fX(end, 120); // Endereço (Corrigido erro "Ausente")
        txt += fX(uf, 2);
        txt += fN(munC, 4);
        txt += "".padEnd(20, " "); // Reservado
        txt += "".padEnd(10, " "); // Reservado
        txt += "\r\n";

        // R04 - VENDAS (Total 325 bytes)
        json.forEach((r, i) => {
            const codMunL = MUNICIPIOS_RFB[normalizarCidade(r.MUNICIPIO_NOME)] || "0000";
            
            let linha = "R04";
            linha += fN(cnpj, 14);              // CNPJ Declarante
            linha += "2025";                    // Ano
            linha += fN(i+1, 7);                // Sequencial
            linha += fDoc(r.CPF_CNPJ_COMPRADOR);// CPF/CNPJ Comprador (14)
            linha += fX(r.NOME_COMPRADOR, 60);  // Nome (60)
            linha += fDoc(r.CPF_CNPJ_VENDEDOR); // CPF/CNPJ Vendedor (14)
            linha += fX(r.NOME_VENDEDOR, 60);   // Nome (60)
            linha += fX(r.CONTRATO, 6);         // Contrato (6)
            linha += fData(r.DATA_DDMMAAAA);    // Data (8) - Higienizada
            linha += fVal(r.VALOR_VENDA, 14);   // Valor (14) - Higienizado
            linha += fVal(r.VALOR_COMISSAO, 14);// Valor (14) - Higienizado
            linha += fX(r.TIPO_URBANO_RURAL, 1);// Tipo (1)
            linha += fX(r.ENDERECO, 60);        // Endereço (60)
            linha += fN(r.CEP, 8);              // CEP (8)
            linha += fN(codMunL, 4);            // Cod Mun (4)
            linha += "".padEnd(20, " ");        // Reservado
            linha += fX(r.UF, 2);               // UF (2)
            linha += "".padEnd(10, " ");        // Reservado
            
            txt += linha + "\r\n";
        });

        txt += "T9" + "".padEnd(100, " ") + "\r\n"; // Trailler

        // Download
        const blob = new Blob([txt], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `DIMOB_ENTREGA_${fN(cnpj, 14)}.txt`;
        link.click();
    };
    reader.readAsArrayBuffer(file);
}

function baixarModelo() {
    const headers = [["SEQUENCIAL", "CPF_CNPJ_COMPRADOR", "NOME_COMPRADOR", "CPF_CNPJ_VENDEDOR", "NOME_VENDEDOR", "CONTRATO", "DATA_DDMMAAAA", "VALOR_VENDA", "VALOR_COMISSAO", "TIPO_URBANO_RURAL", "ENDERECO", "CEP", "MUNICIPIO_NOME", "UF"]];
    const ws = XLSX.utils.aoa_to_sheet(headers);
    // Trava colunas críticas como Texto no Excel
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R = range.s.r; R <= range.e.r; ++R) {
        // Colunas 1 (CPF C), 3 (CPF V), 6 (Data)
        [1, 3, 6].forEach(C => {
            let ref = XLSX.utils.encode_cell({c:C, r:R});
            if(!ws[ref]) ws[ref] = {t:'s', v:''};
            ws[ref].z = '@';
        });
    }
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");
    XLSX.writeFile(wb, "Modelo_DIMOB_Vendas.xlsx");
}
</script>
</body>
</html>

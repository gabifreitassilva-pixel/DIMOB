function gerarTxtFinal() {
    const cnpj = document.getElementById('cnpj_decl').value;
    const nome = document.getElementById('nome_decl').value;
    const end = document.getElementById('end_decl').value;
    const uf = document.getElementById('uf_decl').value;
    const cpfR = document.getElementById('cpf_resp').value;
    const munC = document.getElementById('mun_decl_codigo').value;
    const file = document.getElementById('arquivo_input').files[0];

    if (!file || !cnpj || !cpfR || !end) return alert("Preencha todos os campos do Declarante!");

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        //raw: false e cellText: true ajudam a pegar o valor como aparece na tela do Excel
        const wb = XLSX.read(data, {type: 'array', raw: false, cellText: true}); 
        
        let sheet = wb.Sheets["DADOS_DIMOB"];
        if (!sheet) sheet = wb.Sheets[wb.SheetNames[1]] || wb.Sheets[wb.SheetNames[0]];

        // defval: "" garante que campos vazios não quebrem a lógica
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" }); 
        let txt = "DIMOB" + "".padEnd(369, " ") + "\r\n"; 

        // R01
        txt += "R01" + fN(cnpj, 14) + "20250" + "".padEnd(10, "0") + "0" + "0000000000" 
            + fX(nome, 60) + fN(cpfR, 11) + fX(end, 120) + fX(uf, 2) + fN(munC, 4) + "".padEnd(30, " ") + "\r\n";

        // R04
        json.forEach((r, i) => {
            // Limpeza rigorosa para remover notação científica ou formatação indesejada
            const limparDoc = (doc) => (doc || "").toString().replace(/[^\d]/g, "");

            const compDoc = limparDoc(r.CPF_CNPJ_COMPRADOR);
            const vendDoc = limparDoc(r.CPF_CNPJ_VENDEDOR);

            if (!compDoc && !r.NOME_COMPRADOR) return; 

            const codMunL = MUNICIPIOS_RFB[normalizarCidade(r.MUNICIPIO_NOME)] || "0000";
            
            let linha = "R04";
            linha += fN(cnpj, 14) + "2025" + fN(i+1, 7);
            
            // Aqui usamos a função fDoc que você já tem, mas com o dado limpo
            linha += fDoc(compDoc); 
            linha += fX(r.NOME_COMPRADOR, 60);
            linha += fDoc(vendDoc);
            linha += fX(r.NOME_VENDEDOR, 60);
            
            linha += fX(r.CONTRATO, 6);
            linha += fData(r.DATA_DDMMAAAA);
            linha += fVal(r.VALOR_VENDA, 14);
            linha += fVal(r.VALOR_COMISSAO, 14);
            linha += fX(r.TIPO_URBANO_RURAL, 1);
            linha += fX(r.ENDERECO, 60);
            linha += fN(r.CEP, 8);
            linha += fN(codMunL, 4);
            linha += fX(r.UF, 2); 
            linha += "".padEnd(10, " ");
            
            txt += linha + "\r\n";
        });

        txt += "T9" + "".padEnd(100, " ") + "\r\n";

        const blobTxt = new Blob([txt], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blobTxt);
        link.download = `DIMOB_2025_${fN(cnpj, 14)}.txt`;
        link.click();

        adicionarAoHistorico(nome, cnpj, blobTxt, file);
    };
    reader.readAsArrayBuffer(file);
}

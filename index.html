<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIMOB Pro | Conversor Digital 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --orange: #ff6600; --bg: #0d0d0d; --card: #161616; --text: #eee; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 40px; margin: 0; }
        .container { max-width: 1100px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--card); border: 1px solid #333; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; transition: 0.3s; }
        .card:hover { border-color: var(--orange); }
        .card h3 { color: var(--orange); margin: 0 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        label { font-size: 11px; color: var(--orange); text-transform: uppercase; font-weight: bold; margin-bottom: 5px; display: block; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; box-sizing: border-box; }
        input[readonly] { background: #1a1a1a; color: #888; border-style: dashed; }
        .btn { background: var(--orange); color: #fff; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn:hover { background: #e65c00; transform: translateY(-2px); }
        .btn-model { background: transparent; border: 1px solid #444; color: #aaa; margin-top: 10px; }
        .status-msg { font-size: 11px; color: #888; margin-top: -10px; margin-bottom: 10px; display: none; }
        .instr { font-size: 13px; color: #888; margin-bottom: 15px; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 40px;">
        <h1>DIMOB <span style="color:white">SYSTEM</span></h1>
        <p style="color: var(--orange)">Geração de Arquivo Magnético - Layout R04</p>
    </header>

    <div class="grid">
        <div class="card">
            <h3><i class="fas fa-file-excel"></i> 1. Preparação</h3>
            <p class="instr">Baixe a planilha base. Ela está configurada como <strong>TEXTO</strong> para evitar que o Excel estrague os números de CPF/CNPJ.</p>
            <button onclick="baixarModelo()" class="btn btn-model">Baixar Modelo Vazio</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-search"></i> 2. Declarante</h3>
            <label>CNPJ da Imobiliária</label>
            <input type="text" id="cnpj_decl" placeholder="00.000.000/0001-00" onblur="consultarEmpresa(this.value)">
            <div id="loading" class="status-msg">Consultando base da Receita Federal...</div>
            
            <label>Nome Empresarial</label>
            <input type="text" id="nome_decl" placeholder="Razão Social">
            
            <label>Município (Código RFB Automático)</label>
            <input type="text" id="mun_decl_nome" readonly placeholder="Cidade Identificada">
            <input type="hidden" id="mun_decl_codigo">
            
            <label>CPF do Responsável (RFB)</label>
            <input type="text" id="cpf_resp" placeholder="000.000.000-00">
        </div>

        <div class="card">
            <h3><i class="fas fa-sync"></i> 3. Gerar TXT</h3>
            <p class="instr">Selecione sua planilha XLSX preenchida para gerar o arquivo de entrega.</p>
            <input type="file" id="arquivo_input" accept=".xlsx">
            <button onclick="gerarTxtFinal()" class="btn">CONVERTER PARA TXT</button>
        </div>
    </div>
</div>

<script src="baseMunicipios.js"></script>

<script>
// Funções de Auxílio e Formatação
const fN = (v, t) => (v || "0").toString().replace(/\D/g, "").padStart(t, "0").substring(0, t);
const fX = (v, t) => (v || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().padEnd(t, " ").substring(0, t);

// Função para normalizar busca de municípios
function normalizarCidade(texto) {
    return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
}

// 2. Consulta de CNPJ e Município
async function consultarEmpresa(cnpj) {
    const limpo = cnpj.replace(/\D/g, "");
    if (limpo.length !== 14) return;

    document.getElementById('loading').style.display = 'block';
    try {
        const response = await fetch(`https://publica.cnpj.ws/cnpj/${limpo}`);
        const data = await response.json();

        if (data.razao_social) {
            document.getElementById('nome_decl').value = data.razao_social;
            const cidadeNome = data.estabelecimento.cidade.nome;
            document.getElementById('mun_decl_nome').value = cidadeNome;

            // Busca código RFB na baseMunicipios.js
            const cidadeNormalizada = normalizarCidade(cidadeNome);
            const codigo = MUNICIPIOS_RFB[cidadeNormalizada];
            
            if (codigo) {
                document.getElementById('mun_decl_codigo').value = codigo;
            } else {
                alert("Município identificado, mas código RFB não está na base. Digite manualmente no TXT.");
            }
        }
    } catch (e) {
        alert("Erro ao consultar CNPJ. Preencha os dados manualmente.");
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// 1. Gerador de Planilha Protegida
function baixarModelo() {
    const headers = [["SEQUENCIAL", "CPF_CNPJ_COMPRADOR", "NOME_COMPRADOR", "CPF_CNPJ_VENDEDOR", "NOME_VENDEDOR", "CONTRATO", "DATA_DDMMAAAA", "VALOR_VENDA", "VALOR_COMISSAO", "TIPO_URBANO_RURAL", "ENDERECO", "CEP", "MUNICIPIO_NOME", "UF"]];
    const ws = XLSX.utils.aoa_to_sheet(headers);
    
    // Trava colunas B e D como TEXTO para evitar erro 1.05E+13
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = range.s.r; R <= range.e.r; ++R) {
        const colB = XLSX.utils.encode_cell({r: R, c: 1});
        const colD = XLSX.utils.encode_cell({r: R, c: 3});
        if (ws[colB]) ws[colB].z = '@'; 
        if (ws[colD]) ws[colD].z = '@';
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DIMOB_R04");
    XLSX.writeFile(wb, "Modelo_DIMOB_Vazio.xlsx");
}

// 3. Conversão para TXT
function gerarTxtFinal() {
    const file = document.getElementById('arquivo_input').files[0];
    const cnpj = document.getElementById('cnpj_decl').value;
    const nome = document.getElementById('nome_decl').value;
    const cpfR = document.getElementById('cpf_resp').value;
    const munCod = document.getElementById('mun_decl_codigo').value;

    if (!file || !cnpj || !cpfR) return alert("Erro: Preencha todos os campos do Passo 2 e anexe o arquivo.");

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type: 'array', raw: true}); // raw:true mantém zeros à esquerda
        const planilha = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

        let txt = "DIMOB" + "".padEnd(369, " ") + "\r\n"; // Header

        // R01 - Declarante
        txt += "R01" + fN(cnpj, 14) + "2025" + "0" + "".padEnd(10, "0") + "0" + "00000000" + "00" 
            + fX(nome, 60) + fN(cpfR, 11) + "".padEnd(120, " ") + "SP" + fN(munCod, 4) + "".padEnd(30, " ") + "\r\n";

        // R04 - Vendas
        planilha.forEach((r, i) => {
            // Busca o código do município da linha da planilha
            const codMunLinha = MUNICIPIOS_RFB[normalizarCidade(r.MUNICIPIO_NOME)] || "0000";

            txt += "R04" + fN(cnpj, 14) + "2025" + fN(i+1, 7)
                + fN(r.CPF_CNPJ_COMPRADOR, 14) + fX(r.NOME_COMPRADOR, 60)
                + fN(r.CPF_CNPJ_VENDEDOR, 14) + fX(r.NOME_VENDEDOR, 60)
                + fX(r.CONTRATO, 6) + fN(r.DATA_DDMMAAAA, 8)
                + fN(r.VALOR_VENDA, 14) + fN(r.VALOR_COMISSAO, 14)
                + fX(r.TIPO_URBANO_RURAL, 1) + fX(r.ENDERECO, 60)
                + fN(r.CEP, 8) + fN(codMunLinha, 4)
                + "".padEnd(20, " ") + fX(r.UF, 2) + "".padEnd(10, " ") + "\r\n";
        });

        txt += "T9" + "".padEnd(100, " ") + "\r\n"; // Trailer

        const blob = new Blob([txt], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "DECLARACAO_DIMOB_2025.txt";
        link.click();
    };
    reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>

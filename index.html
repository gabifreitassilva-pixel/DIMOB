<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIMOB 2025 | Conversor Oficial</title>
    
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --orange: #ff6600; --bg: #0d0d0d; --card: #161616; --text: #eee; --table-header: #222; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
        .container { max-width: 1100px; margin: auto; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        
        .card { background: var(--card); border: 1px solid #333; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; }
        .card h3 { color: var(--orange); border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        label { font-size: 11px; color: var(--orange); text-transform: uppercase; font-weight: bold; display: block; margin-top: 10px; }
        input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; margin-top: 5px; }
        
        .btn { background: var(--orange); color: #fff; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; transition: 0.2s; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .obs { font-size: 12px; color: #aaa; margin-top: 5px; line-height: 1.4; }
        .status-msg { font-size: 11px; color: #aaa; margin-top: 5px; display: none; }

        /* Painel Histórico */
        .history-panel { background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 20px; margin-top: 20px; display: none; }
        .history-panel.active { display: block; animation: fadeIn 0.5s; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { text-align: left; background: var(--table-header); color: var(--orange); padding: 12px; border-bottom: 2px solid #444; }
        td { padding: 12px; border-bottom: 1px solid #333; color: #ccc; }
        tr:hover { background: #1f1f1f; }
        
        .btn-sm { padding: 5px 10px; font-size: 11px; margin-right: 5px; border-radius: 4px; text-decoration: none; display: inline-block; cursor: pointer; }
        .btn-green { background: #28a745; color: white; border: none; }
        .btn-blue { background: #007bff; color: white; border: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 40px;">
        <h1>DIMOB <span style="color:#fff">SYSTEM</span></h1>
        <p style="color: var(--orange)">Gerador de Arquivo Magnético - Layout R04</p>
    </header>

    <div class="grid">
        <div class="card">
            <h3><i class="fas fa-table"></i> 1. Planilha Inteligente</h3>
            <p class="obs">
                Baixe o modelo.<br>
                <b>IMPORTANTE:</b> As colunas de CPF/CNPJ já estão formatadas como TEXTO para não perder zeros ou virar notação científica.
            </p>
            <button onclick="baixarModelo()" class="btn" style="background: #333; border: 1px solid #444;">BAIXAR MODELO EXCEL</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-building"></i> 2. Declarante</h3>
            <label>CNPJ</label>
            <input type="text" id="cnpj_decl" onblur="consultarEmpresa(this.value)" placeholder="Apenas números">
            <div id="loading" class="status-msg">Consultando Receita Federal...</div>
            
            <label>Razão Social</label>
            <input type="text" id="nome_decl">
            
            <label>Endereço Completo (R01)</label>
            <input type="text" id="end_decl" placeholder="Carregado automaticamente...">
            
            <div style="display:grid; grid-template-columns: 3fr 1fr; gap:10px">
                <div>
                    <label>Município</label>
                    <input type="text" id="mun_decl_nome" readonly>
                    <input type="hidden" id="mun_decl_codigo">
                </div>
                <div>
                    <label>UF</label>
                    <input type="text" id="uf_decl" readonly>
                </div>
            </div>

            <label>CPF do Responsável (Obrigatório)</label>
            <input type="text" id="cpf_resp" placeholder="Apenas números">
        </div>

        <div class="card">
            <h3><i class="fas fa-file-code"></i> 3. Gerar TXT</h3>
            <p class="obs">Selecione a planilha preenchida.</p>
            <input type="file" id="arquivo_input" accept=".xlsx">
            <button onclick="gerarTxtFinal()" class="btn">CONVERTER E SALVAR</button>
        </div>
    </div>

    <div id="painelHistorico" class="history-panel">
        <h3><i class="fas fa-history"></i> Histórico da Sessão</h3>
        <table>
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Empresa</th>
                    <th>CNPJ</th>
                    <th>Arquivos</th>
                </tr>
            </thead>
            <tbody id="tabelaHistorico"></tbody>
        </table>
    </div>

</div>

<script src="baseMunicipios.js"></script>

<script>
// ============================================================
// 1. HIGIENIZAÇÃO E FORMATAÇÃO
// ============================================================

const fX = (v, t) => {
    let s = (v || "").toString().toUpperCase();
    s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
    return s.padEnd(t, " ").substring(0, t);
};

const fN = (v, t) => {
    let s = (v || "0").toString().replace(/\D/g, ""); 
    return s.padStart(t, "0").substring(0, t);
};

// Reconhecimento Automático CPF vs CNPJ
const fDoc = (v) => {
    let s = (v || "").toString().replace(/\D/g, "");
    if (s.length > 11) return s.padStart(14, "0").substring(0, 14); // CNPJ
    else return s.padStart(11, "0").padEnd(14, " "); // CPF
};

const fVal = (v, t) => {
    if (!v) return "0".padStart(t, "0");
    let s = v.toString().replace(",", ".");
    let num = parseFloat(s);
    if (isNaN(num)) return "0".padStart(t, "0");
    let centavos = Math.round(num * 100);
    return centavos.toString().padStart(t, "0").substring(0, t);
};

const fData = (v) => {
    if (!v) return "00000000";
    // Trata data serial do Excel
    if (typeof v === 'number' && v > 20000) {
        const date = new Date(Math.round((v - 25569) * 86400 * 1000));
        const d = String(date.getUTCDate()).padStart(2, '0');
        const m = String(date.getUTCMonth() + 1).padStart(2, '0');
        const a = date.getUTCFullYear();
        return `${d}${m}${a}`;
    }
    let s = v.toString().replace(/\D/g, ""); 
    if (s.length === 6) s = "0" + s[0] + "0" + s.slice(1);
    else if (s.length === 7) s = "0" + s;
    return s.padStart(8, "0").substring(0, 8);
};

function normalizarCidade(texto) {
    return texto ? texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : "";
}

// ============================================================
// 2. DOWNLOAD DO MODELO (CORREÇÃO DE EXIBIÇÃO DE CNPJ)
// ============================================================
function baixarModelo() {
    const wb = XLSX.utils.book_new();

    // --- ABA 1: INSTRUÇÕES ---
    const instrucoes = [
        ["MANUAL RÁPIDO", ""],
        ["CAMPO", "COMO PREENCHER"],
        ["CPF_CNPJ", "Digite APENAS NÚMEROS. Ex: 10578345000180"],
        ["DATA", "DDMMAAAA (Ex: 01022025)"],
        ["VALOR", "Centavos sem vírgula (Ex: 25000000)"],
        ["TIPO", "'U' (Urbano) ou 'R' (Rural)"],
        ["", ""],
        ["AVISO:", "Vá para a aba DADOS_DIMOB para preencher."]
    ];
    const wsInst = XLSX.utils.aoa_to_sheet(instrucoes);
    wsInst['!cols'] = [{wch: 25}, {wch: 60}];
    XLSX.utils.book_append_sheet(wb, wsInst, "INSTRUCOES");

    // --- ABA 2: DADOS (CONFIGURAÇÃO BLINDADA) ---
    const headers = [["SEQUENCIAL", "CPF_CNPJ_COMPRADOR", "NOME_COMPRADOR", "CPF_CNPJ_VENDEDOR", "NOME_VENDEDOR", "CONTRATO", "DATA_DDMMAAAA", "VALOR_VENDA", "VALOR_COMISSAO", "TIPO_URBANO_RURAL", "ENDERECO", "CEP", "MUNICIPIO_NOME", "UF"]];
    const wsDados = XLSX.utils.aoa_to_sheet(headers);

    // 1. LARGURA DAS COLUNAS (AUMENTADA PARA CNPJ NÃO FICAR ######)
    wsDados['!cols'] = [
        {wch: 12}, // Seq
        {wch: 30}, // CPF_CNPJ COMPRADOR (Largo para caber 14 digitos)
        {wch: 40}, // Nome
        {wch: 30}, // CPF_CNPJ VENDEDOR (Largo para caber 14 digitos)
        {wch: 40}, // Nome
        {wch: 15}, // Contrato
        {wch: 15}, // Data
        {wch: 18}, // Valor
        {wch: 18}, // Comissao
        {wch: 10}, // Tipo
        {wch: 50}, // Endereco
        {wch: 15}, // CEP
        {wch: 25}, // Municipio
        {wch: 5}   // UF
    ];

    // 2. FORÇAR FORMATO DE TEXTO EM TODAS AS LINHAS
    // Isso garante que 10578345000180 fique como texto e não vire 1,05E+13
    const range = {s: {c: 0, r: 0}, e: {c: 13, r: 5000}}; 
    if(!wsDados['!ref']) wsDados['!ref'] = XLSX.utils.encode_range(range);

    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            let ref = XLSX.utils.encode_cell({c: C, r: R});
            if (!wsDados[ref]) wsDados[ref] = { t: 's', v: '' }; // Cria célula vazia se não existir
            
            // Força tipo String e formato Texto (@)
            wsDados[ref].t = 's'; 
            wsDados[ref].z = '@'; 
        }
    }

    XLSX.utils.book_append_sheet(wb, wsDados, "DADOS_DIMOB");
    XLSX.writeFile(wb, "Modelo_DIMOB_2025.xlsx");
}

// ============================================================
// 3. CONSULTA AUTOMÁTICA
// ============================================================
async function consultarEmpresa(cnpj) {
    const limpo = cnpj.replace(/\D/g, "");
    if (limpo.length !== 14) return;
    document.getElementById('loading').style.display = 'block';
    
    try {
        const res = await fetch(`https://publica.cnpj.ws/cnpj/${limpo}`);
        const data = await res.json();
        if (data.razao_social) {
            document.getElementById('nome_decl').value = data.razao_social;
            const e = data.estabelecimento;
            const end = `${e.tipo_logradouro} ${e.logradouro}, ${e.numero} ${e.complemento||""} - ${e.bairro}`.trim();
            document.getElementById('end_decl').value = end;
            document.getElementById('mun_decl_nome').value = e.cidade.nome;
            document.getElementById('uf_decl').value = e.estado.sigla;
            const cod = MUNICIPIOS_RFB[normalizarCidade(e.cidade.nome)] || "";
            document.getElementById('mun_decl_codigo').value = cod;
        }
    } catch (e) {} 
    finally { document.getElementById('loading').style.display = 'none'; }
}

// ============================================================
// 4. CONVERSÃO E HISTÓRICO
// ============================================================

function adicionarAoHistorico(empresa, cnpj, blobTxt, fileExcel) {
    const tbody = document.getElementById('tabelaHistorico');
    const painel = document.getElementById('painelHistorico');
    const now = new Date();
    const hora = now.toLocaleTimeString([], {hour: '2digit', minute:'2digit'});
    const urlTxt = URL.createObjectURL(blobTxt);
    const urlExcel = URL.createObjectURL(fileExcel);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${hora}</td>
        <td>${empresa.substring(0, 20)}...</td>
        <td>${fN(cnpj, 14)}</td>
        <td>
            <a href="${urlExcel}" download="${fileExcel.name}" class="btn-sm btn-green">
                <i class="fas fa-file-excel"></i> XLSX
            </a>
            <a href="${urlTxt}" download="DIMOB_${fN(cnpj, 14)}.txt" class="btn-sm btn-blue">
                <i class="fas fa-file-alt"></i> TXT
            </a>
        </td>
    `;
    tbody.insertBefore(tr, tbody.firstChild);
    painel.classList.add('active');
}

function gerarTxtFinal() {
    const cnpj = document.getElementById('cnpj_decl').value;
    const nome = document.getElementById('nome_decl').value;
    const end = document.getElementById('end_decl').value;
    const uf = document.getElementById('uf_decl').value;
    const cpfR = document.getElementById('cpf_resp').value;
    const munC = document.getElementById('mun_decl_codigo').value;
    const file = document.getElementById('arquivo_input').files[0];

    if (!file || !cnpj || !cpfR || !end) return alert("Preencha todos os campos do Declarante!");

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type: 'array', raw: false});
        
        let sheet = wb.Sheets["DADOS_DIMOB"];
        if (!sheet) sheet = wb.Sheets[wb.SheetNames[1]] || wb.Sheets[wb.SheetNames[0]];

        const json = XLSX.utils.sheet_to_json(sheet);
        let txt = "DIMOB" + "".padEnd(369, " ") + "\r\n"; 

        // R01
        txt += "R01" + fN(cnpj, 14) + "20250" + "".padEnd(10, "0") + "0" + "0000000000" 
            + fX(nome, 60) + fN(cpfR, 11) + fX(end, 120) + fX(uf, 2) + fN(munC, 4) + "".padEnd(30, " ") + "\r\n";

        // R04
        json.forEach((r, i) => {
            if (!r.CPF_CNPJ_COMPRADOR && !r.NOME_COMPRADOR) return; // Pula linhas vazias

            const codMunL = MUNICIPIOS_RFB[normalizarCidade(r.MUNICIPIO_NOME)] || "0000";
            
            let linha = "R04";
            linha += fN(cnpj, 14) + "2025" + fN(i+1, 7);
            
            // Inteligência para manter o número correto no TXT
            linha += fDoc(r.CPF_CNPJ_COMPRADOR); 
            linha += fX(r.NOME_COMPRADOR, 60);
            linha += fDoc(r.CPF_CNPJ_VENDEDOR);
            linha += fX(r.NOME_VENDEDOR, 60);
            
            linha += fX(r.CONTRATO, 6);
            linha += fData(r.DATA_DDMMAAAA);
            linha += fVal(r.VALOR_VENDA, 14);
            linha += fVal(r.VALOR_COMISSAO, 14);
            linha += fX(r.TIPO_URBANO_RURAL, 1);
            linha += fX(r.ENDERECO, 60);
            linha += fN(r.CEP, 8);
            linha += fN(codMunL, 4);
            linha += fX(r.UF, 2); 
            linha += "".padEnd(10, " ");
            
            txt += linha + "\r\n";
        });

        txt += "T9" + "".padEnd(100, " ") + "\r\n";

        const blobTxt = new Blob([txt], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blobTxt);
        link.download = `DIMOB_2025_${fN(cnpj, 14)}.txt`;
        link.click();

        adicionarAoHistorico(nome, cnpj, blobTxt, file);
    };
    reader.readAsArrayBuffer(file);
}
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log(e));
        });
    }
</script>

</body>
</html>

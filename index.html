<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIMOB SYSTEM | Inteligência Cadastral</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --orange: #ff6600; --bg: #0d0d0d; --card: #161616; --text: #eee; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
        .container { max-width: 1100px; margin: auto; }
        
        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid var(--orange); padding-bottom: 20px; }
        .header h1 { color: var(--white); margin: 0; font-size: 2.5em; text-transform: uppercase; }
        .header h1 span { color: var(--orange); }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .card { background: var(--card); border: 1px solid #333; padding: 25px; border-radius: 12px; transition: 0.3s; }
        .card:hover { border-color: var(--orange); box-shadow: 0 0 15px rgba(255, 102, 0, 0.2); }
        .card h3 { color: var(--orange); border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; display: flex; align-items: center; gap: 10px; }

        label { font-size: 11px; color: var(--orange); text-transform: uppercase; font-weight: bold; display: block; margin-top: 15px; }
        input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; margin-top: 5px; font-size: 14px;}
        input:focus { border-color: var(--orange); outline: none; background: #2a2a2a; }

        .btn { background: var(--orange); color: #fff; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        .status-msg { font-size: 11px; color: #00ff00; margin-top: 5px; display: none; }
        .history-panel { background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 20px; margin-top: 30px; display: none; }
        .history-panel.active { display: block; animation: fadeIn 0.5s; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; background: #222; color: var(--orange); padding: 12px; font-size: 11px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #333; color: #ccc; font-size: 13px; }
        
        .btn-sm { padding: 6px 12px; font-size: 10px; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase;}
        .btn-green { background: #28a745; color: white; margin-right: 5px; }
        .btn-blue { background: #007bff; color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>DIMOB <span>SYSTEM</span></h1>
        <p style="color: #888">Geração de Arquivo Magnético Blindada | 2026</p>
    </header>

    <div class="grid">
        <div class="card">
            <h3><i class="fas fa-file-excel"></i> 1. Planilha Base</h3>
            <p style="font-size: 12px; color: #aaa;">Baixe o modelo blindado para evitar erros de formatação nos documentos.</p>
            <button onclick="baixarModelo()" class="btn" style="background: #333; border: 1px solid #444;">Baixar Excel</button>
        </div>

        <div class="card">
            <h3><i class="fas fa-search"></i> 2. Auto-Preenchimento</h3>
            <label>CNPJ da Imobiliária / Construtora</label>
            <input type="text" id="cnpj_decl" onblur="fluxoBuscaCNPJ(this.value)" placeholder="Apenas números">
            <div id="loading" class="status-msg"><i class="fas fa-spinner fa-spin"></i> Sincronizando com Base de Dados...</div>
            
            <label>Razão Social</label>
            <input type="text" id="nome_decl" readonly style="background: #1a1a1a; color: #888;">
            
            <label>Endereço Completo</label>
            <input type="text" id="end_decl">
            
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px">
                <div>
                    <label>Cidade (Nome)</label>
                    <input type="text" id="mun_nome">
                </div>
                <div>
                    <label>UF</label>
                    <input type="text" id="uf_decl" maxlength="2">
                </div>
            </div>
            
            <label>Código Município (RFB)</label>
            <input type="text" id="mun_codigo" placeholder="Gerado automaticamente">

            <label>CPF do Responsável (Obrigatório)</label>
            <input type="text" id="cpf_resp" placeholder="Apenas números">
        </div>

        <div class="card">
            <h3><i class="fas fa-sync"></i> 3. Converter</h3>
            <label>Importar Planilha Preenchida</label>
            <input type="file" id="arquivo_input" accept=".xlsx">
            <button onclick="gerarTxtDIMOB()" class="btn">Gerar TXT Oficial</button>
            <p class="obs" style="font-size: 10px; color: #666; margin-top: 15px;">* O arquivo será gerado seguindo o Layout R04 da Receita Federal.</p>
        </div>
    </div>

    <div id="painelHistorico" class="history-panel">
        <h3><i class="fas fa-history"></i> Histórico de Sessão</h3>
        <table>
            <thead>
                <tr>
                    <th>Empresa / Emissão</th>
                    <th>Documento</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabelaHistorico"></tbody>
        </table>
    </div>
</div>

<script src="baseMunicipios.js"></script>

<script>
// --- UTILITÁRIOS ---
const limpar = (v) => {
    if (!v) return "";
    let s = v.toString().trim();
    if (s.toUpperCase().includes('E+')) s = Number(s).toLocaleString('fullwide', {useGrouping:false});
    return s.replace(/\D/g, "");
};

const fX = (v, t) => (v || "").toString().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").padEnd(t, " ").substring(0, t);
const fN = (v, t) => limpar(v).padStart(t, "0").substring(0, t);
const fDoc = (v) => {
    let s = limpar(v);
    return s.length > 11 ? s.padStart(14, "0").substring(0, 14) : s.padStart(11, "0").padEnd(14, " ");
};
const fVal = (v, t) => {
    let n = parseFloat((v || "0").toString().replace(",", "."));
    return isNaN(n) ? "0".padStart(t, "0") : Math.round(n * 100).toString().padStart(t, "0").substring(0, t);
};
const fData = (v) => {
    if (!v) return "00000000";
    if (typeof v === 'number') {
        const d = new Date(Math.round((v - 25569) * 86400 * 1000));
        return `${String(d.getUTCDate()).padStart(2,'0')}${String(d.getUTCMonth()+1).padStart(2,'0')}${d.getUTCFullYear()}`;
    }
    return v.toString().replace(/\D/g, "").padStart(8, "0").substring(0, 8);
};

// --- FLUXO DE BUSCA COM FALLBACK (API DUPLA) ---
async function fluxoBuscaCNPJ(cnpj) {
    const doc = limpar(cnpj);
    if (doc.length !== 14) return;
    
    document.getElementById('loading').style.display = 'block';
    
    // Tenta API 1: CNPJ.ws (Mais completa)
    let sucesso = await buscarAPI1(doc);
    
    // Se falhar, tenta API 2: ReceitaWS (Contingência)
    if (!sucesso) {
        console.warn("API 1 falhou, tentando contingência...");
        await buscarAPI2(doc);
    }
    
    document.getElementById('loading').style.display = 'none';
}

async function buscarAPI1(cnpj) {
    try {
        const res = await fetch(`https://publica.cnpj.ws/cnpj/${cnpj}`);
        const data = await res.json();
        if (data.razao_social) {
            preencherCampos(
                data.razao_social, 
                `${data.estabelecimento.tipo_logradouro} ${data.estabelecimento.logradouro}, ${data.estabelecimento.numero} - ${data.estabelecimento.bairro}`,
                data.estabelecimento.cidade.nome,
                data.estabelecimento.estado.sigla
            );
            return true;
        }
    } catch(e) { return false; }
}

async function buscarAPI2(cnpj) {
    try {
        // ReceitaWS requer JSONP ou Proxy para evitar CORS no browser, mas usamos via fetch simples para teste
        const res = await fetch(`https://cors-anywhere.herokuapp.com/https://www.receitaws.com.br/v1/cnpj/${cnpj}`);
        const data = await res.json();
        if (data.nome) {
            preencherCampos(data.nome, `${data.logradouro}, ${data.numero} - ${data.bairro}`, data.municipio, data.uf);
            return true;
        }
    } catch(e) { return false; }
}

function preencherCampos(nome, end, mun, uf) {
    document.getElementById('nome_decl').value = nome;
    document.getElementById('end_decl').value = end;
    document.getElementById('mun_nome').value = mun;
    document.getElementById('uf_decl').value = uf;
    
    // Tradução Automática para Código Município RFB
    if (typeof MUNICIPIOS_RFB !== 'undefined') {
        const cidNorm = mun.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        document.getElementById('mun_codigo').value = MUNICIPIOS_RFB[cidNorm] || "0000";
    }
}

// --- GERAÇÃO DO TXT ---
function gerarTxtDIMOB() {
    const cnpj = document.getElementById('cnpj_decl').value;
    const nome = document.getElementById('nome_decl').value;
    const end = document.getElementById('end_decl').value;
    const uf = document.getElementById('uf_decl').value;
    const cpfR = document.getElementById('cpf_resp').value;
    const munC = document.getElementById('mun_codigo').value || "0000";
    const input = document.getElementById('arquivo_input');

    if (!input.files[0] || !cnpj || !cpfR) {
        alert("Erro: Preencha o CNPJ, CPF do Responsável e anexe a Planilha.");
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type: 'array', raw: false});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

        let txt = "DIMOB" + "".padEnd(369, " ") + "\r\n";
        
        // R01
        txt += "R01" + fN(cnpj, 14) + "20260000000000000000000000" 
            + fX(nome, 60) + fN(cpfR, 11) + fX(end, 120) + fX(uf, 2) + fN(munC, 4) + "".padEnd(30, " ") + "\r\n";

        // R04
        rows.forEach((r, idx) => {
            if (!r.CPF_CNPJ_COMPRADOR) return;
            let l = "R04";
            l += fN(cnpj, 14) + "2026" + fN(idx+1, 7);
            l += fDoc(r.CPF_CNPJ_COMPRADOR) + fX(r.NOME_COMPRADOR, 60);
            l += fDoc(r.CPF_CNPJ_VENDEDOR) + fX(r.NOME_VENDEDOR, 60);
            l += fX(r.CONTRATO, 6) + fData(r.DATA_DDMMAAAA);
            l += fVal(r.VALOR_VENDA, 14) + fVal(r.VALOR_COMISSAO, 14);
            l += fX(r.TIPO_URBANO_RURAL, 1) + fX(r.ENDERECO, 60);
            l += fN(r.CEP, 8) + fN(munC, 4) + fX(uf, 2) + "".padEnd(10, " ");
            txt += l + "\r\n";
        });

        txt += "T9" + "".padEnd(100, " ") + "\r\n";

        const hoje = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
        const nomeFinal = `DIMOB_OFICIAL_${nome.substring(0,12).trim().replace(/\s/g, '_')}_${hoje}.txt`;
        
        const blob = new Blob([txt], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = nomeFinal;
        link.click();

        registraHistorico(nome, cnpj, hoje, blob, input.files[0]);
    };
    reader.readAsArrayBuffer(input.files[0]);
}

function registraHistorico(empresa, cnpj, data, blob, file) {
    const table = document.getElementById('tabelaHistorico');
    const row = table.insertRow(0);
    row.innerHTML = `<td><strong>${empresa}</strong><br><small>Gerado em: ${data}</small></td><td>${fN(cnpj, 14)}</td>
        <td><a href="${URL.createObjectURL(blob)}" download class="btn-sm btn-blue">Baixar TXT</a> 
            <a href="${URL.createObjectURL(file)}" download class="btn-sm btn-green">Ver Excel</a></td>`;
    document.getElementById('painelHistorico').classList.add('active');
}

function baixarModelo() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([["SEQUENCIAL", "CPF_CNPJ_COMPRADOR", "NOME_COMPRADOR", "CPF_CNPJ_VENDEDOR", "NOME_VENDEDOR", "CONTRATO", "DATA_DDMMAAAA", "VALOR_VENDA", "VALOR_COMISSAO", "TIPO_URBANO_RURAL", "ENDERECO", "CEP", "MUNICIPIO_NOME", "UF"]]);
    XLSX.utils.book_append_sheet(wb, ws, "DADOS");
    XLSX.writeFile(wb, "Modelo_DIMOB_2026.xlsx");
}
</script>
</body>
</html>

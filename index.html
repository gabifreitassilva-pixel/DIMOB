<div class="card">
    <h3><i class="fas fa-search"></i> 2. Declarante</h3>
    <label>CNPJ da Imobiliária</label>
    <input type="text" id="cnpj_decl" placeholder="00.000.000/0001-00" onblur="consultarEmpresa(this.value)">
    <div id="loading" class="status-msg">Consultando base da Receita Federal...</div>
    
    <label>Nome Empresarial</label>
    <input type="text" id="nome_decl" placeholder="Razão Social">
    
    <label>Endereço Completo (Para o Registro R01)</label>
    <input type="text" id="end_decl" placeholder="Rua, Número, Complemento, Bairro">
    
    <label>CEP</label>
    <input type="text" id="cep_decl" placeholder="00000-000">

    <label>Município (Código RFB Automático)</label>
    <input type="text" id="mun_decl_nome" readonly placeholder="Cidade Identificada">
    <input type="hidden" id="mun_decl_codigo">
    
    <label>CPF do Responsável (RFB)</label>
    <input type="text" id="cpf_resp" placeholder="000.000.000-00">
</div>

<script>
async function consultarEmpresa(cnpj) {
    const limpo = cnpj.replace(/\D/g, "");
    if (limpo.length !== 14) return;

    document.getElementById('loading').style.display = 'block';
    try {
        const response = await fetch(`https://publica.cnpj.ws/cnpj/${limpo}`);
        const data = await response.json();

        if (data.razao_social) {
            // 1. Nome Empresarial
            document.getElementById('nome_decl').value = data.razao_social;

            // 2. Montagem do Endereço Completo conforme o cartão CNPJ
            const est = data.estabelecimento;
            const enderecoFormatado = `${est.tipo_logradouro} ${est.logradouro}, ${est.numero} ${est.complemento ? est.complemento : ""} - ${est.bairro}`;
            document.getElementById('end_decl').value = enderecoFormatado.trim();
            
            // 3. CEP
            document.getElementById('cep_decl').value = est.cep;

            // 4. Município e Código RFB
            const cidadeNome = est.cidade.nome;
            document.getElementById('mun_decl_nome').value = cidadeNome;

            const cidadeNormalizada = normalizarCidade(cidadeNome);
            const codigo = MUNICIPIOS_RFB[cidadeNormalizada];
            
            if (codigo) {
                document.getElementById('mun_decl_codigo').value = codigo;
            } else {
                alert("Município localizado, mas código RFB não encontrado na base interna.");
            }
        }
    } catch (e) {
        alert("Erro ao consultar CNPJ. Verifique os dados manualmente.");
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}
</script>
